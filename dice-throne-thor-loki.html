<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dice Throne — Bot Thor / Loki (PV + Statuts + Boutons)</title>
  <style>
    :root{
      --bg:#0b0f14; --text:#e8f0ff; --muted:#9fb0c8;
      --border:rgba(255,255,255,.10);
      --good:#34d399; --bad:#fb7185; --warn:#fbbf24; --acc:#7dd3fc;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(125,211,252,.18), transparent 55%),
        radial-gradient(1100px 650px at 80% 30%, rgba(52,211,153,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    h1{font-size:18px;margin:0 0 10px 0}
    .sub{color:var(--muted);font-size:13px;line-height:1.35;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:1.12fr .88fr;gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .panel{
      border:1px solid var(--border); border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      padding:14px; box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.18);font-size:12px
    }
    select,input[type="number"],button{
      border:1px solid var(--border); border-radius:10px;
      background:rgba(0,0,0,.22); color:var(--text);
      padding:10px 10px; font-size:14px; outline:none;
    }
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg, rgba(125,211,252,.22), rgba(125,211,252,.10))}
    button.secondary{background:rgba(0,0,0,.22)}
    button.danger{background:linear-gradient(180deg, rgba(251,113,133,.22), rgba(251,113,133,.10))}
    button:disabled{opacity:.45;cursor:not-allowed}
    .sep{height:1px;background:var(--border);margin:12px 0}
    .card{
      background:rgba(0,0,0,.18); border:1px solid var(--border);
      border-radius:12px; padding:12px;
    }
    .card h3{margin:0 0 10px 0;font-size:14px}
    .hp{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .bar{
      height:10px;flex:1;min-width:180px;border-radius:999px;border:1px solid var(--border);
      background:rgba(255,255,255,.06); overflow:hidden;
    }
    .bar>div{height:100%;background:linear-gradient(90deg, rgba(52,211,153,.85), rgba(125,211,252,.85))}
    .dice{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .die{
      width:58px;height:58px;border-radius:14px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      user-select:none; position:relative;
    }
    .die .n{font-size:18px;font-weight:800;line-height:1}
    .die .f{font-size:11px;color:var(--muted);margin-top:4px}
    .die.locked{outline:2px solid rgba(52,211,153,.55)}
    .die .lk{
      position:absolute;top:6px;right:6px;font-size:10px;
      padding:4px 6px;border-radius:8px;background:rgba(0,0,0,.25);border:1px solid var(--border)
    }
    .actions{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .action{
      display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap;
      padding:10px;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.16);
    }
    .action .name{font-weight:900}
    .action .req{font-size:12px;color:var(--muted)}
    .tag{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--border)}
    .tag.good{color:var(--good)} .tag.bad{color:var(--bad)} .tag.warn{color:var(--warn)}
    .small{font-size:12px;color:var(--muted)}
    .statline{display:flex;gap:8px;flex-wrap:wrap}
    .stat{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      min-width:260px;
      padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.12);
      font-size:13px;
    }
    .btns{display:flex;gap:6px}
    .btns button{padding:8px 10px}
    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px; white-space:pre-wrap; line-height:1.35;
      background:rgba(0,0,0,.25); border:1px solid var(--border);
      border-radius:12px;padding:10px;max-height:340px;overflow:auto;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Dice Throne — Bot Thor / Loki</h1>
  <div class="sub">
    ✅ Boutons séparés : <b>Fin du tour (joueur)</b> puis <b>Jouer le tour du bot</b>.<br>
    Statuts gérés (simplifiés) : Thor (Brise-garde, Électro, Mjöllnir) · Loki (Illusion, Sac à malice, Ensorcelé).
  </div>

  <div class="grid">
    <!-- GAME -->
    <div class="panel">
      <div class="row space">
        <div class="row">
          <span class="pill">
            <span class="small">Joueur</span>
            <select id="playerHero">
              <option value="thor">Thor</option>
              <option value="loki">Loki</option>
            </select>
          </span>
          <span class="pill">
            <span class="small">Bot</span>
            <select id="botHero">
              <option value="thor">Thor</option>
              <option value="loki">Loki</option>
            </select>
          </span>
          <button class="secondary" id="resetBtn">Reset</button>
        </div>
        <div class="row">
          <span class="pill"><span class="small">Tour</span> <strong id="turnLabel">Joueur</strong></span>
          <span class="pill"><span class="small">Relances</span> <strong id="rerollsLeft">2</strong></span>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row" style="gap:12px">
        <div class="card" style="flex:1;min-width:280px">
          <h3>Joueur</h3>
          <div class="hp">
            <span class="pill"><span class="small">PV</span> <strong id="pHP">50</strong></span>
            <div class="bar"><div id="pHPFill" style="width:100%"></div></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="secondary" id="pMinus">-1</button>
            <button class="secondary" id="pPlus">+1</button>
            <input type="number" id="pSet" value="50" min="0" max="99" style="width:88px" />
            <button class="secondary" id="pApply">Appliquer</button>
          </div>
          <div class="small" id="pRes"></div>
        </div>

        <div class="card" style="flex:1;min-width:280px">
          <h3>Bot</h3>
          <div class="hp">
            <span class="pill"><span class="small">PV</span> <strong id="bHP">50</strong></span>
            <div class="bar"><div id="bHPFill" style="width:100%"></div></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="secondary" id="bMinus">-1</button>
            <button class="secondary" id="bPlus">+1</button>
            <input type="number" id="bSet" value="50" min="0" max="99" style="width:88px" />
            <button class="secondary" id="bApply">Appliquer</button>
          </div>
          <div class="small" id="bRes"></div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row space">
        <div class="row">
          <button class="primary" id="rollBtn">Lancer 5 dés</button>
          <button class="secondary" id="rerollBtn" disabled>Relancer (non lock)</button>
          <button class="secondary" id="lockAllBtn" disabled>Lock tous</button>

          <button class="secondary" id="endPlayerTurnBtn">Fin du tour (joueur)</button>
          <button class="primary" id="playBotBtn">Jouer le tour du bot</button>
        </div>
        <div class="row">
          <span class="tag good" id="straightTag" style="display:none"></span>
        </div>
      </div>

      <div class="dice" id="diceRow"></div>

      <div class="sep"></div>

      <div class="card">
        <h3>Capacités disponibles (joueur)</h3>
        <div class="small">Choisis une capacité, puis clique <b>Fin du tour (joueur)</b>.</div>
        <div class="actions" id="actionsList"></div>
      </div>
    </div>

    <!-- STATUS + LOG -->
    <div class="panel">
      <div class="card">
        <h3>Statuts Joueur</h3>
        <div class="statline" id="pStatus"></div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h3>Statuts Bot</h3>
        <div class="statline" id="bStatus"></div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="row space">
          <h3 style="margin:0">Log</h3>
          <button class="secondary" id="clearLog">Clear</button>
        </div>
        <div class="log" id="logBox"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------- Utils ---------------- */
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const sum = (arr)=>arr.reduce((a,b)=>a+b,0);
const counts = (arr)=>arr.reduce((m,v)=>(m[v]=(m[v]||0)+1,m),{});
const uniq = (arr)=>[...new Set(arr)];

function hasSmallStraight(nums){
  const s = uniq(nums).sort((a,b)=>a-b);
  const seqs = [[1,2,3,4],[2,3,4,5],[3,4,5,6]];
  return seqs.some(seq => seq.every(n=>s.includes(n)));
}
function hasLargeStraight(nums){
  const s = uniq(nums).sort((a,b)=>a-b);
  return s.length===5 && (
    [1,2,3,4,5].every(n=>s.includes(n)) ||
    [2,3,4,5,6].every(n=>s.includes(n))
  );
}
function hasTriple(nums){
  return Object.values(counts(nums)).some(v=>v>=3);
}
function log(msg){
  const box = document.getElementById("logBox");
  const t = new Date().toLocaleTimeString();
  box.textContent += `[${t}] ${msg}\n`;
  box.scrollTop = box.scrollHeight;
}

/* ---------------- State ---------------- */
const state = {
  turn: "player", // "player" | "bot"
  rerollsLeft: 2,
  dice: Array.from({length:5}, ()=>({v:1, locked:false})),
  player: null,
  bot: null,
};

function newHero(key){
  if(key==="thor"){
    return { key, hp:50, hpMax:50, brise:0, electro:0, mjollnir:"self" };
  }
  return { key, hp:50, hpMax:50, illusion:0, sac:0, ensorcele:0 };
}

/* ---------------- Face mapping ---------------- */
function thorFace(n){
  if(n<=3) return "Marteau";
  if(n<=5) return "Grandeur";
  return "Foudre";
}
function lokiFace(n){
  if(n<=2) return "Sceptre";
  if(n<=4) return "Illusion";
  if(n===5) return "Mensonge";
  return "Fourberie";
}
function faceOf(heroKey, n){
  return heroKey==="thor" ? thorFace(n) : lokiFace(n);
}
function faceCounts(heroKey, nums){
  const c = {};
  for(const n of nums){
    const f = faceOf(heroKey, n);
    c[f] = (c[f]||0)+1;
  }
  return c;
}

/* ---------------- Damage / heal ---------------- */
function dealDamage(target, amount){
  target.hp = clamp(target.hp - amount, 0, target.hpMax);
}
function heal(target, amount){
  target.hp = clamp(target.hp + amount, 0, target.hpMax);
}

/* ---------------- Thor statuses (simplifiés) ---------------- */
function thorTryBriseGarde(attacker){
  if(attacker.brise<=0) return {used:false, undef:false};
  const use = confirm("Brise-garde dispo. Dépenser 1 pour tenter rendre l'attaque imparable (sur 4-5) ?");
  if(!use) return {used:false, undef:false};
  attacker.brise = clamp(attacker.brise-1,0,2);
  const r = randInt(1,6);
  const ok = (r===4 || r===5);
  log(`Brise-garde: dé = ${r} → ${ok ? "IMParable" : "normal"}.`);
  return {used:true, undef: ok};
}
function thorAskMjollnir(attacker, defender){
  if(attacker.mjollnir!=="self") return;
  const use = confirm("Mjöllnir est chez Thor. Le lancer ? (inflige 1 dégât imparable)");
  if(!use) return;
  attacker.mjollnir="opponent";
  dealDamage(defender, 1);
  log("Mjöllnir lancé → 1 dégât IMParable (source isolée).");
}

/* ---------------- Abilities ---------------- */
function thorAbilities(nums, actor, defender){
  const f = faceCounts("thor", nums);
  const avail = [];

  // Martèlement III: 3/4/5 Marteaux -> 5/6/8
  if((f["Marteau"]||0) >= 3){
    const m = f["Marteau"]||0;
    const dmg = m>=5 ? 8 : (m===4 ? 6 : 5);
    avail.push({
      id:"thor_martelement",
      name:`Martèlement III`,
      req:`${m} Marteaux (>=3)`,
      score:dmg,
      run:()=>{
        if(hasTriple(nums)){
          actor.electro = clamp(actor.electro+1,0,4);
          log("Martèlement: triple → +1 Électrokinésie.");
        }
        const bg = thorTryBriseGarde(actor);
        thorAskMjollnir(actor, defender);
        dealDamage(defender, dmg);
        log(`Martèlement → ${dmg} dégâts ${bg.undef ? "(rendue imparable - info)" : ""}`);
      }
    });
  }

  // Boum boum! : 2 Marteau + 2 Foudre => +2 electro, 6 dmg
  if((f["Marteau"]||0)>=2 && (f["Foudre"]||0)>=2){
    avail.push({
      id:"thor_boum",
      name:"Boum boum !",
      req:"≥2 Marteaux & ≥2 Foudres",
      score:6.5,
      run:()=>{
        actor.electro = clamp(actor.electro+2,0,4);
        const bg = thorTryBriseGarde(actor);
        thorAskMjollnir(actor, defender);
        dealDamage(defender, 6);
        log(`Boum boum → 6 dégâts. +2 Électro. ${bg.undef ? "(rendue imparable - info)" : ""}`);
      }
    });
  }

  // Puissante invocation II
  if((f["Marteau"]||0)>=1 && (f["Grandeur"]||0)>=2 && (f["Foudre"]||0)>=1){
    avail.push({
      id:"thor_invoc",
      name:"Puissante invocation II",
      req:"≥1 Marteau, ≥2 Grandeur, ≥1 Foudre",
      score:5.0,
      run:()=>{
        actor.brise = clamp(actor.brise+2,0,2);
        heal(actor, 3);
        log("Invocation: +2 Brise-garde (max2) et soigne 3.");
        if(actor.mjollnir==="self"){
          actor.electro = clamp(actor.electro+3,0,4);
          log("Mjöllnir sur Thor → +3 Électrokinésie.");
        } else {
          actor.mjollnir="self";
          dealDamage(defender, 4);
          log("Récupère Mjöllnir → 4 dégâts collatéraux (imparables non simulés).");
        }
      }
    });
  }

  // Éclair II (grande suite)
  if(hasLargeStraight(nums)){
    avail.push({
      id:"thor_eclair",
      name:"Éclair II",
      req:"Grande suite",
      score:12,
      run:()=>{
        actor.electro = clamp(actor.electro+2,0,4);
        const bg = thorTryBriseGarde(actor);
        thorAskMjollnir(actor, defender);
        dealDamage(defender, 12);
        log(`Éclair II → 12 dégâts. +2 Électro. ${bg.undef ? "(rendue imparable - info)" : ""}`);
        log("Éclair II: Lancer/Récupérer Mjöllnir (non auto).");
      }
    });
  }

  // Ultime (5 foudres) -> 14
  if((f["Foudre"]||0) >= 5){
    avail.push({
      id:"thor_ult",
      name:"POUR ASGARD ! (ULT)",
      req:"5 Foudres",
      score:15,
      run:()=>{
        actor.brise = clamp(actor.brise+1,0,2);
        dealDamage(defender, 14);
        log("ULT Thor → 14 dégâts. +1 Brise-garde. (Mjöllnir x4 non auto).");
      }
    });
  }

  // Heal (3 grandeur)
  if((f["Grandeur"]||0) >= 3){
    avail.push({
      id:"thor_heal",
      name:"Muscles Asgardiens",
      req:"≥3 Grandeur",
      score:3.5,
      run:()=>{
        heal(actor, 4);
        log("Muscles Asgardiens → soigne 4.");
      }
    });
  }

  return avail;
}

function lokiAbilities(nums, actor, defender){
  const f = faceCounts("loki", nums);
  const avail = [];

  // Raillerie: 3/4/5 sceptres => 6/7/8
  if((f["Sceptre"]||0) >= 3){
    const s = f["Sceptre"]||0;
    const dmg = s>=5?8:(s===4?7:6);
    avail.push({
      id:"loki_raillerie",
      name:"Raillerie",
      req:`${s} Sceptres (>=3)`,
      score:dmg,
      run:()=>{
        dealDamage(defender, dmg);
        log(`Raillerie → ${dmg} dégâts.`);
      }
    });
  }

  // Facéties: ≥2 mensonges => Illusion + Sac
  if((f["Mensonge"]||0) >= 2){
    avail.push({
      id:"loki_faceties",
      name:"Facéties",
      req:"≥2 Mensonges",
      score:2.5,
      run:()=>{
        actor.illusion = clamp(actor.illusion+1,0,2);
        actor.sac = clamp(actor.sac+1,0,2);
        log("Facéties → Pioche 1 (log), +1 Illusion, +1 Sac à malice.");
      }
    });
  }

  // Avarie: petite suite => + Sac, 7 dmg
  if(hasSmallStraight(nums)){
    avail.push({
      id:"loki_avarie",
      name:"Avarie",
      req:"Petite suite",
      score:7.2,
      run:()=>{
        actor.sac = clamp(actor.sac+1,0,2);
        dealDamage(defender, 7);
        log("Avarie → +1 Sac à malice, 7 dégâts.");
      }
    });
  }

  // Agent double: ≥4 fourberies => + Illusion, inflige 2 Ensorcelé, 7 (imparables non simulés)
  if((f["Fourberie"]||0) >= 4){
    avail.push({
      id:"loki_agent_double",
      name:"Agent double",
      req:"≥4 Fourberies",
      score:8.5,
      run:()=>{
        actor.illusion = clamp(actor.illusion+1,0,2);
        defender.ensorcele = clamp(defender.ensorcele+2,0,3);
        dealDamage(defender, 7);
        log("Agent double → +1 Illusion, inflige 2 Ensorcelé, 7 dégâts (imparables non simulés).");
      }
    });
  }

  // Confusion (approx): ≥2 illusion + ≥2 sceptre => 2 ensorcelé + 7
  if((f["Illusion"]||0) >= 2 && (f["Sceptre"]||0) >= 2){
    avail.push({
      id:"loki_confusion",
      name:"Confusion (approx)",
      req:"≥2 Illusion & ≥2 Sceptre",
      score:6.0,
      run:()=>{
        defender.ensorcele = clamp(defender.ensorcele+2,0,3);
        dealDamage(defender, 7);
        log("Confusion (approx) → inflige 2 Ensorcelé, 7 dégâts.");
      }
    });
  }

  // Ultime (approx): 5 fourberies -> 10 + tokens
  if((f["Fourberie"]||0) >= 5){
    avail.push({
      id:"loki_ult",
      name:"But glorieux ! (ULT) (approx)",
      req:"5 Fourberies",
      score:11,
      run:()=>{
        actor.illusion = clamp(actor.illusion+1,0,2);
        actor.sac = clamp(actor.sac+1,0,2);
        defender.ensorcele = clamp(defender.ensorcele+3,0,3);
        dealDamage(defender, 10);
        log("ULT Loki (approx) → +1 Illusion, +1 Sac, inflige 3 Ensorcelé, 10 dégâts.");
      }
    });
  }

  return avail;
}

/* ---------------- Turn flow ---------------- */
function rollAll(){
  for(const d of state.dice){
    if(!d.locked) d.v = randInt(1,6);
  }
}
function resetRollPhase(){
  state.rerollsLeft = 2;
  state.dice.forEach(d=>{d.locked=false; d.v=1;});
  document.getElementById("rerollBtn").disabled = true;
  document.getElementById("lockAllBtn").disabled = true;
}
function beginRollPhase(){
  document.getElementById("rerollBtn").disabled = false;
  document.getElementById("lockAllBtn").disabled = false;
}
function render(){
  document.getElementById("turnLabel").textContent = state.turn==="player" ? "Joueur" : "Bot";
  document.getElementById("rerollsLeft").textContent = state.rerollsLeft;

  document.getElementById("pHP").textContent = state.player.hp;
  document.getElementById("bHP").textContent = state.bot.hp;
  document.getElementById("pSet").value = state.player.hp;
  document.getElementById("bSet").value = state.bot.hp;
  document.getElementById("pHPFill").style.width = `${clamp((state.player.hp/state.player.hpMax)*100,0,100)}%`;
  document.getElementById("bHPFill").style.width = `${clamp((state.bot.hp/state.bot.hpMax)*100,0,100)}%`;

  document.getElementById("pRes").textContent = state.player.key==="thor"
    ? `Brise-garde: ${state.player.brise}/2 · Électro: ${state.player.electro}/4 · Mjöllnir: ${state.player.mjollnir==="self"?"chez toi":"chez adversaire"}`
    : `Illusion: ${state.player.illusion}/2 · Sac: ${state.player.sac}/2 · Ensorcelé: ${state.player.ensorcele}/3`;
  document.getElementById("bRes").textContent = state.bot.key==="thor"
    ? `Brise-garde: ${state.bot.brise}/2 · Électro: ${state.bot.electro}/4 · Mjöllnir: ${state.bot.mjollnir==="self"?"chez bot":"chez joueur"}`
    : `Illusion: ${state.bot.illusion}/2 · Sac: ${state.bot.sac}/2 · Ensorcelé: ${state.bot.ensorcele}/3`;

  // dice
  const heroKey = state.turn==="player" ? state.player.key : state.bot.key;
  const diceRow = document.getElementById("diceRow");
  diceRow.innerHTML="";
  state.dice.forEach((d)=>{
    const el=document.createElement("div");
    el.className="die"+(d.locked?" locked":"");
    el.innerHTML=`<div class="n">${d.v}</div><div class="f">${faceOf(heroKey,d.v)}</div><div class="lk">${d.locked?"LOCK":""}</div>`;
    el.addEventListener("click", ()=>{
      if(document.getElementById("rerollBtn").disabled) return;
      d.locked=!d.locked;
      render();
    });
    diceRow.appendChild(el);
  });

  // straight tag
  const nums = state.dice.map(d=>d.v);
  const st = document.getElementById("straightTag");
  if(hasLargeStraight(nums)){ st.style.display="inline-block"; st.textContent="Grande suite"; }
  else if(hasSmallStraight(nums)){ st.style.display="inline-block"; st.textContent="Petite suite"; }
  else st.style.display="none";

  // actions (only for player turn)
  const list=document.getElementById("actionsList");
  list.innerHTML="";
  if(state.turn!=="player"){
    const el=document.createElement("div");
    el.className="action";
    el.innerHTML=`<div><div class="name">Tour du bot</div><div class="req">Clique "Jouer le tour du bot".</div></div><span class="tag warn">bot</span>`;
    list.appendChild(el);
  } else {
    const actor=state.player, defender=state.bot;
    const abilities = actor.key==="thor" ? thorAbilities(nums, actor, defender) : lokiAbilities(nums, actor, defender);
    if(abilities.length===0){
      const el=document.createElement("div");
      el.className="action";
      el.innerHTML=`<div><div class="name">Aucune capacité</div><div class="req">Relance ou attaque basique (à la main).</div></div><span class="tag bad">—</span>`;
      list.appendChild(el);
    } else {
      abilities.sort((a,b)=>b.score-a.score).forEach(a=>{
        const el=document.createElement("div");
        el.className="action";
        el.innerHTML=`<div><div class="name">${a.name}</div><div class="req">${a.req}</div></div><button class="primary">Activer</button>`;
        el.querySelector("button").addEventListener("click", ()=>{
          a.run();
          log("OK. Clique 'Fin du tour (joueur)'.");
          render();
        });
        list.appendChild(el);
      });
    }
  }

  renderStatuses();
}

function renderStatuses(){
  const p = state.player, b = state.bot;
  const pHost=document.getElementById("pStatus");
  const bHost=document.getElementById("bStatus");
  pHost.innerHTML=""; bHost.innerHTML="";

  function addStat(host, title, value, min, max, setter){
    const el=document.createElement("div");
    el.className="stat";
    el.innerHTML=`<div><strong>${title}</strong><div class="small">${value}</div></div>
                  <div class="btns"><button class="secondary">-</button><button class="secondary">+</button></div>`;
    const [m,pb]=el.querySelectorAll("button");
    m.onclick=()=>{setter(clamp(value-1,min,max));};
    pb.onclick=()=>{setter(clamp(value+1,min,max));};
    host.appendChild(el);
  }

  // player
  if(p.key==="thor"){
    addStat(pHost,"Brise-garde",p.brise,0,2,v=>{p.brise=v;render();});
    addStat(pHost,"Électrokinésie",p.electro,0,4,v=>{p.electro=v;render();});
    const mj=document.createElement("div");
    mj.className="stat";
    mj.innerHTML=`<div><strong>Mjöllnir</strong><div class="small">${p.mjollnir==="self"?"sur ton plateau":"sur l’adversaire"}</div></div>
                  <div class="btns"><button class="secondary">Toggle</button></div>`;
    mj.querySelector("button").onclick=()=>{p.mjollnir = (p.mjollnir==="self"?"opponent":"self"); render();};
    pHost.appendChild(mj);
  } else {
    addStat(pHost,"Illusion",p.illusion,0,2,v=>{p.illusion=v;render();});
    addStat(pHost,"Sac à malice",p.sac,0,2,v=>{p.sac=v;render();});
    addStat(pHost,"Ensorcelé",p.ensorcele,0,3,v=>{p.ensorcele=v;render();});
  }

  // bot
  if(b.key==="thor"){
    addStat(bHost,"Brise-garde",b.brise,0,2,v=>{b.brise=v;render();});
    addStat(bHost,"Électrokinésie",b.electro,0,4,v=>{b.electro=v;render();});
    const mj=document.createElement("div");
    mj.className="stat";
    mj.innerHTML=`<div><strong>Mjöllnir</strong><div class="small">${b.mjollnir==="self"?"sur plateau bot":"sur le joueur"}</div></div>
                  <div class="btns"><button class="secondary">Toggle</button></div>`;
    mj.querySelector("button").onclick=()=>{b.mjollnir = (b.mjollnir==="self"?"opponent":"self"); render();};
    bHost.appendChild(mj);
  } else {
    addStat(bHost,"Illusion",b.illusion,0,2,v=>{b.illusion=v;render();});
    addStat(bHost,"Sac à malice",b.sac,0,2,v=>{b.sac=v;render();});
    addStat(bHost,"Ensorcelé",b.ensorcele,0,3,v=>{b.ensorcele=v;render();});
  }
}

/* ---------------- Bot play ---------------- */
function botPlay(){
  // safety
  if(state.bot.hp<=0 || state.player.hp<=0){ render(); return; }

  // reset + 1st roll
  resetRollPhase();
  beginRollPhase();
  rollAll();
  log(`Bot lance: [${state.dice.map(d=>d.v).join(", ")}]`);
  render();

  // up to 2 rerolls
  for(let i=0;i<2;i++){
    const nums = state.dice.map(d=>d.v);
    const actor=state.bot, defender=state.player;
    const abilities = actor.key==="thor" ? thorAbilities(nums, actor, defender) : lokiAbilities(nums, actor, defender);
    abilities.sort((a,b)=>b.score-a.score);
    const best=abilities[0];

    if(!best || best.score>=10) break;

    // lock strategy
    state.dice.forEach(d=>d.locked=false);
    if(best.req.includes("suite")){
      const seen=new Set();
      for(const d of state.dice){ if(!seen.has(d.v)){ d.locked=true; seen.add(d.v); } }
    } else {
      if(actor.key==="thor"){
        if(best.req.includes("Foudre")) state.dice.forEach(d=>{ if(thorFace(d.v)==="Foudre") d.locked=true; });
        else if(best.req.includes("Grandeur")) state.dice.forEach(d=>{ if(thorFace(d.v)==="Grandeur") d.locked=true; });
        else state.dice.forEach(d=>{ if(thorFace(d.v)==="Marteau") d.locked=true; });
      } else {
        if(best.req.includes("Fourberie")) state.dice.forEach(d=>{ if(lokiFace(d.v)==="Fourberie") d.locked=true; });
        else if(best.req.includes("Mensonge")) state.dice.forEach(d=>{ if(lokiFace(d.v)==="Mensonge") d.locked=true; });
        else state.dice.forEach(d=>{ if(lokiFace(d.v)==="Sceptre") d.locked=true; });
      }
    }

    state.rerollsLeft--;
    rollAll();
    log(`Bot relance: [${state.dice.map(d=>d.v).join(", ")}]`);
    render();
  }

  // final choose
  const nums = state.dice.map(d=>d.v);
  const actor=state.bot, defender=state.player;
  const abilities = actor.key==="thor" ? thorAbilities(nums, actor, defender) : lokiAbilities(nums, actor, defender);
  abilities.sort((a,b)=>b.score-a.score);
  const best=abilities[0];

  if(best){
    log(`Bot choisit: ${best.name} (${best.req})`);
    best.run();
  } else {
    dealDamage(defender, 2);
    log("Bot: attaque basique → 2 dégâts.");
  }

  // end bot turn
  state.turn="player";
  resetRollPhase();
  log("---- Tour du Joueur ----");
  render();
}

/* ---------------- Events ---------------- */
document.getElementById("rollBtn").addEventListener("click", ()=>{
  if(state.turn!=="player"){ alert("Ce n'est pas ton tour."); return; }
  beginRollPhase();
  rollAll();
  log(`Joueur lance: [${state.dice.map(d=>d.v).join(", ")}]`);
  render();
});
document.getElementById("rerollBtn").addEventListener("click", ()=>{
  if(state.turn!=="player") return;
  if(state.rerollsLeft<=0) return;
  state.rerollsLeft--;
  rollAll();
  log(`Joueur relance: [${state.dice.map(d=>d.v).join(", ")}]`);
  render();
});
document.getElementById("lockAllBtn").addEventListener("click", ()=>{
  if(document.getElementById("rerollBtn").disabled) return;
  state.dice.forEach(d=>d.locked=true);
  render();
});

document.getElementById("endPlayerTurnBtn").addEventListener("click", ()=>{
  if(state.turn!=="player"){ alert("Pas ton tour."); return; }
  state.turn="bot";
  resetRollPhase();
  log("---- Tour du Bot ---- (clique 'Jouer le tour du bot')");
  render();
});

document.getElementById("playBotBtn").addEventListener("click", ()=>{
  if(state.turn!=="bot"){ alert("Ce n'est pas le tour du bot."); return; }
  botPlay();
});

document.getElementById("resetBtn").addEventListener("click", ()=>location.reload());
document.getElementById("clearLog").addEventListener("click", ()=>{document.getElementById("logBox").textContent="";});

function bindHp(){
  document.getElementById("pMinus").onclick=()=>{state.player.hp=clamp(state.player.hp-1,0,99);render();};
  document.getElementById("pPlus").onclick=()=>{state.player.hp=clamp(state.player.hp+1,0,99);render();};
  document.getElementById("bMinus").onclick=()=>{state.bot.hp=clamp(state.bot.hp-1,0,99);render();};
  document.getElementById("bPlus").onclick=()=>{state.bot.hp=clamp(state.bot.hp+1,0,99);render();};
  document.getElementById("pApply").onclick=()=>{state.player.hp=clamp(Number(document.getElementById("pSet").value||0),0,99);render();};
  document.getElementById("bApply").onclick=()=>{state.bot.hp=clamp(Number(document.getElementById("bSet").value||0),0,99);render();};
}
bindHp();

document.getElementById("playerHero").addEventListener("change", (e)=>{
  state.player = newHero(e.target.value);
  log(`Joueur = ${e.target.value.toUpperCase()}`);
  resetRollPhase();
  state.turn="player";
  render();
});
document.getElementById("botHero").addEventListener("change", (e)=>{
  state.bot = newHero(e.target.value);
  log(`Bot = ${e.target.value.toUpperCase()}`);
  resetRollPhase();
  render();
});

/* ---------------- Init ---------------- */
state.player = newHero(document.getElementById("playerHero").value);
state.bot = newHero(document.getElementById("botHero").value);
resetRollPhase();
log("---- Tour du Joueur ----");
log("Prêt. Clique 'Lancer 5 dés', puis choisis une capacité, puis 'Fin du tour (joueur)', puis 'Jouer le tour du bot'.");
render();
</script>
</body>
</html>
